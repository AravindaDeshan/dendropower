<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Store Management System | Vidul BioMass (Pvt) Ltd</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* CSS will be placed here for internal CSS */
        :root {
            --primary-color: #4CAF50;
            --secondary-color: #2E7D32;
            --accent-color: #8BC34A;
            --dark-color: #1B5E20;
            --light-color: #C8E6C9;
            --text-color: #333;
            --light-text: #f5f5f5;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }

        body {
            background-color: #f5f5f5;
            color: var(--text-color);
            overflow-x: hidden;
        }

        .container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar Styles */
        .sidebar {
            width: 250px;
            background-color: var(--dark-color);
            color: var(--light-text);
            padding: 20px 0;
            transition: var(--transition);
            position: fixed;
            height: 100vh;
            z-index: 100;
            box-shadow: var(--shadow);
        }

        .sidebar-header {
            text-align: center;
            padding: 20px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .sidebar-header h3 {
            color: var(--light-text);
            font-size: 1.2rem;
        }

        .sidebar-menu {
            margin-top: 20px;
        }

        .sidebar-menu ul {
            list-style: none;
        }

        .sidebar-menu li {
            margin-bottom: 5px;
        }

        .sidebar-menu a {
            display: block;
            padding: 12px 20px;
            color: var(--light-text);
            text-decoration: none;
            transition: var(--transition);
            border-left: 3px solid transparent;
        }

        .sidebar-menu a:hover, .sidebar-menu a.active {
            background-color: rgba(255, 255, 255, 0.1);
            border-left: 3px solid var(--accent-color);
        }

        .sidebar-menu i {
            margin-right: 10px;
            width: 20px;
            text-align: center;
        }

        /* Main Content Styles */
        .main-content {
            flex: 1;
            margin-left: 250px;
            transition: var(--transition);
        }

        /* Header Styles */
        .header {
            background-color: white;
            padding: 15px 20px;
            box-shadow: var(--shadow);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 90;
        }

        .header h1 {
            color: var(--dark-color);
            font-size: 1.5rem;
        }

        .header h1 span {
            font-size: 1rem;
            color: var(--text-color);
            display: block;
            margin-top: 5px;
        }

        .user-info {
            display: flex;
            align-items: center;
        }

        .user-info img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 10px;
        }

        .logout-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            transition: var(--transition);
        }

        .logout-btn:hover {
            background-color: var(--secondary-color);
        }

        /* Content Area Styles */
        .content {
            padding: 20px;
        }

        /* Dashboard Cards */
        .cards {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: var(--shadow);
            transition: var(--transition);
            cursor: pointer;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }

        .card h3 {
            color: var(--dark-color);
            margin-bottom: 10px;
        }

        .card p {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary-color);
        }

        .card i {
            font-size: 2.5rem;
            color: var(--accent-color);
            margin-bottom: 15px;
        }

        /* Recent Activities */
        .recent-activities {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: var(--shadow);
        }

        .recent-activities h2 {
            margin-bottom: 20px;
            color: var(--dark-color);
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }

        .activity-item {
            display: flex;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #f5f5f5;
        }

        .activity-item:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }

        .activity-icon {
            width: 40px;
            height: 40px;
            background-color: var(--light-color);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            color: var(--primary-color);
        }

        .activity-details h4 {
            margin-bottom: 5px;
            color: var(--text-color);
        }

        .activity-details p {
            color: #777;
            font-size: 0.9rem;
        }

        .activity-time {
            color: #999;
            font-size: 0.8rem;
        }

        /* Form Styles */
        .form-container {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: var(--shadow);
            margin-bottom: 20px;
        }

        .form-container h2 {
            margin-bottom: 20px;
            color: var(--dark-color);
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
        }

        .form-group textarea {
            height: 100px;
            resize: vertical;
        }

        .btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            transition: var(--transition);
            font-size: 1rem;
        }

        .btn:hover {
            background-color: var(--secondary-color);
        }

        /* Table Styles */
        .table-container {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: var(--shadow);
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        table th, table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        table th {
            background-color: var(--light-color);
            color: var(--dark-color);
        }

        table tr:hover {
            background-color: #f9f9f9;
        }

        .status {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .status-pending {
            background-color: #FFF3E0;
            color: #E65100;
        }

        .status-completed {
            background-color: #E8F5E9;
            color: #2E7D32;
        }

        /* Login Page Styles */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: var(--light-color);
        }

        .login-box {
            background-color: white;
            padding: 40px;
            border-radius: 8px;
            box-shadow: var(--shadow);
            width: 100%;
            max-width: 400px;
            text-align: center;
        }

        .login-box h2 {
            margin-bottom: 20px;
            color: var(--dark-color);
        }

        .login-box img {
            width: 100px;
            margin-bottom: 20px;
        }

        .login-form .form-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .login-btn {
            width: 100%;
            padding: 12px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: var(--transition);
            font-size: 1rem;
        }

        .login-btn:hover {
            background-color: var(--secondary-color);
        }

        /* Footer Styles */
        .footer {
            text-align: center;
            padding: 20px;
            background-color: var(--dark-color);
            color: var(--light-text);
            margin-left: 250px;
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fade-in {
            animation: fadeIn 0.5s ease forwards;
        }

        /* Responsive Styles */
        @media (max-width: 992px) {
            .sidebar {
                width: 70px;
                overflow: hidden;
            }
            .sidebar-header h3, .sidebar-menu a span {
                display: none;
            }
            .sidebar-menu a {
                text-align: center;
                padding: 12px 5px;
            }
            .sidebar-menu i {
                margin-right: 0;
                font-size: 1.2rem;
            }
            .main-content {
                margin-left: 70px;
            }
            .footer {
                margin-left: 70px;
            }
        }

        @media (max-width: 768px) {
            .cards {
                grid-template-columns: 1fr;
            }
            .header {
                flex-direction: column;
                text-align: center;
            }
            .user-info {
                margin-top: 15px;
            }
        }

        /* Hidden class for page switching */
        .page {
            display: none;
        }
        .page.active {
            display: block;
        }

        /* Report filter styles */
        .report-filters {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .report-filters select, .report-filters button {
            padding: 8px 12px;
        }

        /* Print styles for reports */
        @media print {
            .sidebar, .header, .report-filters, .footer {
                display: none !important;
            }
            .main-content {
                margin-left: 0 !important;
            }
            .table-container {
                box-shadow: none !important;
                padding: 0 !important;
            }
            body {
                background-color: white !important;
            }
        }
    </style>
</head>
<body>
    <!-- Login Page -->
    <div id="login-page" class="login-container">
        <div class="login-box">
            <img src="https://via.placeholder.com/100x100?text=VBM" alt="Vidul BioMass Logo">
            <h2>Store Management System</h2>
            <form id="login-form" class="login-form">
                <div class="form-group">
                    <label for="username">Username</label>
                    <input type="text" id="username" placeholder="Enter username" required>
                </div>
                <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" placeholder="Enter password" required>
                </div>
                <button type="submit" class="login-btn">Login</button>
            </form>
        </div>
    </div>

    <!-- Main Application -->
    <div id="app" class="container" style="display: none;">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h3>Store Management</h3>
            </div>
            <div class="sidebar-menu">
                <ul>
                    <li><a href="#" class="nav-link active" data-page="dashboard"><i class="fas fa-tachometer-alt"></i> <span>Dashboard</span></a></li>
                    <li><a href="#" class="nav-link" data-page="issue-items"><i class="fas fa-arrow-up"></i> <span>Issue Items</span></a></li>
                    <li><a href="#" class="nav-link" data-page="return-items"><i class="fas fa-arrow-down"></i> <span>Return Items</span></a></li>
                    <li><a href="#" class="nav-link" data-page="reports"><i class="fas fa-file-alt"></i> <span>Reports</span></a></li>
                    <li><a href="#" class="nav-link" data-page="add-items"><i class="fas fa-plus-circle"></i> <span>Add Items</span></a></li>
                </ul>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Header -->
            <div class="header">
                <h1>Store Management System <span>Vidul BioMass (Pvt) Ltd - Dehiattakandiya</span></h1>
                <div class="user-info">
                    <button class="logout-btn" id="logout-btn"><i class="fas fa-sign-out-alt"></i> Logout</button>
                </div>
            </div>

            <!-- Content Area -->
            <div class="content">
                <!-- Dashboard Page -->
                <div id="dashboard-page" class="page active fade-in">
                    <div class="cards">
                        <div class="card">
                            <i class="fas fa-box-open"></i>
                            <h3>Total Items</h3>
                            <p id="total-items">0</p>
                        </div>
                        <div class="card">
                            <i class="fas fa-clipboard-list"></i>
                            <h3>Active Jobs</h3>
                            <p id="active-jobs">0</p>
                        </div>
                        <div class="card">
                            <i class="fas fa-check-circle"></i>
                            <h3>Items Checked Out</h3>
                            <p id="items-checked-out">0</p>
                        </div>
                    </div>

                    <div class="recent-activities">
                        <h2>Recent Activities</h2>
                        <div id="activities-list">
                            <!-- Activities will be loaded here -->
                        </div>
                    </div>
                </div>

                <!-- Issue Items Page -->
                <div id="issue-items-page" class="page">
                    <div class="form-container">
                        <h2>Issue Items</h2>
                        <form id="issue-form">
                            <div class="form-group">
                                <label for="person-name">Person Name</label>
                                <input type="text" id="person-name" placeholder="Enter person name" required>
                            </div>
                            <div class="form-group">
                                <label for="purpose">Purpose</label>
                                <input type="text" id="purpose" placeholder="Enter purpose" required>
                            </div>
                            <div class="form-group">
                                <label for="issue-date">Date</label>
                                <input type="date" id="issue-date" required>
                            </div>
                            <div class="form-group">
                                <label>Items</label>
                                <div id="items-container">
                                    <div class="item-row">
                                        <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                                            <input type="text" class="item-name" placeholder="Item name" style="flex: 2;" required>
                                            <input type="number" class="item-quantity" placeholder="Qty" style="flex: 1;" min="1" required>
                                            <input type="text" class="item-unit" placeholder="Unit (kg, liters)" style="flex: 1;">
                                            <button type="button" class="btn remove-item-btn" style="background-color: #f44336; padding: 0 10px;"><i class="fas fa-times"></i></button>
                                        </div>
                                    </div>
                                </div>
                                <button type="button" id="add-item-btn" class="btn" style="background-color: var(--accent-color); margin-top: 10px;"><i class="fas fa-plus"></i> Add Another Item</button>
                            </div>
                            <button type="submit" class="btn">Issue Items</button>
                        </form>
                    </div>

                    <div class="table-container">
                        <h2>Recently Issued Items</h2>
                        <table id="issued-items-table">
                            <thead>
                                <tr>
                                    <th>Job ID</th>
                                    <th>Person</th>
                                    <th>Purpose</th>
                                    <th>Date</th>
                                    <th>Items</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Issued items will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Return Items Page -->
                <div id="return-items-page" class="page">
                    <div class="form-container">
                        <h2>Return Items</h2>
                        <form id="return-form">
                            <div class="form-group">
                                <label for="job-id">Job ID</label>
                                <input type="text" id="job-id" placeholder="Enter Job ID" required>
                            </div>
                            <div class="form-group">
                                <label for="return-date">Return Date</label>
                                <input type="date" id="return-date" required>
                            </div>
                            <div class="form-group">
                                <label>Items to Return</label>
                                <div id="return-items-container">
                                    <!-- Items will be loaded here after entering Job ID -->
                                </div>
                            </div>
                            <button type="submit" class="btn">Return Items</button>
                        </form>
                    </div>

                    <div class="table-container">
                        <h2>Recently Returned Items</h2>
                        <table id="returned-items-table">
                            <thead>
                                <tr>
                                    <th>Job ID</th>
                                    <th>Person</th>
                                    <th>Return Date</th>
                                    <th>Items</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Returned items will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Reports Page -->
                <div id="reports-page" class="page">
                    <div class="form-container">
                        <h2>Generate Reports</h2>
                        <div class="report-filters">
                            <select id="report-type" class="form-group">
                                <option value="daily">Daily Report</option>
                                <option value="weekly">Weekly Report</option>
                                <option value="monthly">Monthly Report</option>
                                <option value="annual">Annual Report</option>
                                <option value="inventory">Inventory Report</option>
                            </select>
                            <input type="date" id="report-date" class="form-group">
                            <select id="report-month" class="form-group" style="display: none;">
                                <option value="01">January</option>
                                <option value="02">February</option>
                                <option value="03">March</option>
                                <option value="04">April</option>
                                <option value="05">May</option>
                                <option value="06">June</option>
                                <option value="07">July</option>
                                <option value="08">August</option>
                                <option value="09">September</option>
                                <option value="10">October</option>
                                <option value="11">November</option>
                                <option value="12">December</option>
                            </select>
                            <input type="number" id="report-year" class="form-group" min="2000" max="2100" style="display: none;" value="2023">
                            <button id="generate-report" class="btn">Generate Report</button>
                            <button id="print-report" class="btn" style="background-color: #607D8B;">Print PDF</button>
                        </div>
                    </div>

                    <div class="table-container">
                        <h2 id="report-title">Report</h2>
                        <div id="report-content">
                            <!-- Report content will be loaded here -->
                            <p>Please select report type and generate report.</p>
                        </div>
                    </div>
                </div>

                <!-- Add Items Page -->
                <div id="add-items-page" class="page">
                    <div class="form-container">
                        <h2>Add New Items to Inventory</h2>
                        <form id="add-item-form">
                            <div class="form-group">
                                <label for="item-name">Item Name</label>
                                <input type="text" id="item-name" placeholder="Enter item name" required>
                            </div>
                            <div class="form-group">
                                <label for="item-category">Category</label>
                                <input type="text" id="item-category" placeholder="Enter category">
                            </div>
                            <div class="form-group">
                                <label for="item-quantity">Quantity</label>
                                <input type="number" id="item-quantity" placeholder="Enter quantity" min="1" required>
                            </div>
                            <div class="form-group">
                                <label for="item-unit">Unit</label>
                                <input type="text" id="item-unit" placeholder="Enter unit (kg, liters, etc.)">
                            </div>
                            <div class="form-group">
                                <label for="item-description">Description</label>
                                <textarea id="item-description" placeholder="Enter description"></textarea>
                            </div>
                            <button type="submit" class="btn">Add Item</button>
                        </form>
                    </div>

                    <div class="table-container">
                        <h2>Current Inventory</h2>
                        <table id="inventory-table">
                            <thead>
                                <tr>
                                    <th>Item Name</th>
                                    <th>Category</th>
                                    <th>Quantity</th>
                                    <th>Unit</th>
                                    <th>Description</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Inventory items will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="footer">
            <p>All Rights Reserved | M.G.A.D Dharmasiri</p>
            <p id="current-year"></p>
        </div>
    </div>

    <!-- JavaScript Files -->
    <script type="module">
        // Import Firebase functions
        import { database, ref, push, set, onValue, query, orderByChild, equalTo, auth, signInWithEmailAndPassword, signOut } from './js/firebase.js';

        // DOM Elements
        const loginPage = document.getElementById('login-page');
        const app = document.getElementById('app');
        const loginForm = document.getElementById('login-form');
        const logoutBtn = document.getElementById('logout-btn');
        const currentYear = document.getElementById('current-year');
        
        // Set current year in footer
        currentYear.textContent = new Date().getFullYear();

        // Login Functionality
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            // Check credentials (username: Dehiattakandiya, password: Vidul2025)
            if (username === 'Dehiattakandiya' && password === 'Vidul2025') {
                try {
                    // Sign in with Firebase Auth
                    await signInWithEmailAndPassword(auth, 'store@vidulbiomass.com', 'Vidul2025');
                    
                    // Hide login page and show app
                    loginPage.style.display = 'none';
                    app.style.display = 'flex';
                    
                    // Initialize the application
                    initApp();
                } catch (error) {
                    alert('Login failed. Please try again.');
                    console.error(error);
                }
            } else {
                alert('Invalid username or password');
            }
        });

        // Logout Functionality
        logoutBtn.addEventListener('click', async () => {
            try {
                await signOut(auth);
                app.style.display = 'none';
                loginPage.style.display = 'flex';
                document.getElementById('username').value = '';
                document.getElementById('password').value = '';
            } catch (error) {
                console.error('Logout error:', error);
            }
        });

        // Navigation between pages
        function setupNavigation() {
            const navLinks = document.querySelectorAll('.nav-link');
            
            navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const pageId = link.getAttribute('data-page');
                    
                    // Remove active class from all links and pages
                    navLinks.forEach(navLink => navLink.classList.remove('active'));
                    document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
                    
                    // Add active class to clicked link and corresponding page
                    link.classList.add('active');
                    document.getElementById(`${pageId}-page`).classList.add('active', 'fade-in');
                });
            });
        }

        // Initialize the application
        function initApp() {
            setupNavigation();
            setupIssueItems();
            setupReturnItems();
            setupReports();
            setupAddItems();
            loadDashboardData();
        }

        // Issue Items Functionality
        function setupIssueItems() {
            const issueForm = document.getElementById('issue-form');
            const addItemBtn = document.getElementById('add-item-btn');
            const itemsContainer = document.getElementById('items-container');
            
            // Set default date to today
            document.getElementById('issue-date').valueAsDate = new Date();
            
            // Add item row
            addItemBtn.addEventListener('click', () => {
                const itemRow = document.createElement('div');
                itemRow.className = 'item-row';
                itemRow.innerHTML = `
                    <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                        <input type="text" class="item-name" placeholder="Item name" style="flex: 2;" required>
                        <input type="number" class="item-quantity" placeholder="Qty" style="flex: 1;" min="1" required>
                        <input type="text" class="item-unit" placeholder="Unit (kg, liters)" style="flex: 1;">
                        <button type="button" class="btn remove-item-btn" style="background-color: #f44336; padding: 0 10px;"><i class="fas fa-times"></i></button>
                    </div>
                `;
                itemsContainer.appendChild(itemRow);
                
                // Add event listener to remove button
                itemRow.querySelector('.remove-item-btn').addEventListener('click', () => {
                    itemsContainer.removeChild(itemRow);
                });
            });
            
            // Submit issue form
            issueForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const personName = document.getElementById('person-name').value;
                const purpose = document.getElementById('purpose').value;
                const date = document.getElementById('issue-date').value;
                
                // Get all items
                const items = [];
                const itemRows = document.querySelectorAll('.item-row');
                
                itemRows.forEach(row => {
                    items.push({
                        name: row.querySelector('.item-name').value,
                        quantity: parseInt(row.querySelector('.item-quantity').value),
                        unit: row.querySelector('.item-unit').value || null
                    });
                });
                
                // Generate job ID (timestamp + random 3 digits)
                const jobId = `${Date.now()}${Math.floor(Math.random() * 900) + 100}`;
                
                // Create transaction object
                const transaction = {
                    jobId,
                    personName,
                    purpose,
                    date,
                    items,
                    status: 'issued',
                    timestamp: new Date().toISOString()
                };
                
                try {
                    // Save to Firebase
                    const transactionsRef = ref(database, 'transactions');
                    const newTransactionRef = push(transactionsRef);
                    await set(newTransactionRef, transaction);
                    
                    // Update inventory
                    await updateInventory(items, 'issue');
                    
                    alert(`Items issued successfully! Job ID: ${jobId}`);
                    issueForm.reset();
                    itemsContainer.innerHTML = `
                        <div class="item-row">
                            <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                                <input type="text" class="item-name" placeholder="Item name" style="flex: 2;" required>
                                <input type="number" class="item-quantity" placeholder="Qty" style="flex: 1;" min="1" required>
                                <input type="text" class="item-unit" placeholder="Unit (kg, liters)" style="flex: 1;">
                                <button type="button" class="btn remove-item-btn" style="background-color: #f44336; padding: 0 10px;"><i class="fas fa-times"></i></button>
                            </div>
                        </div>
                    `;
                    
                    // Reload issued items table
                    loadIssuedItems();
                    loadDashboardData();
                } catch (error) {
                    console.error('Error issuing items:', error);
                    alert('Failed to issue items. Please try again.');
                }
            });
            
            // Load issued items table
            loadIssuedItems();
        }
        
        // Load issued items table
        function loadIssuedItems() {
            const issuedItemsTable = document.getElementById('issued-items-table').querySelector('tbody');
            issuedItemsTable.innerHTML = '<tr><td colspan="6">Loading...</td></tr>';
            
            const transactionsRef = ref(database, 'transactions');
            const issuedQuery = query(transactionsRef, orderByChild('status'), equalTo('issued'));
            
            onValue(issuedQuery, (snapshot) => {
                issuedItemsTable.innerHTML = '';
                
                if (!snapshot.exists()) {
                    issuedItemsTable.innerHTML = '<tr><td colspan="6">No issued items found</td></tr>';
                    return;
                }
                
                const transactions = [];
                snapshot.forEach(childSnapshot => {
                    transactions.push(childSnapshot.val());
                });
                
                // Sort by date (newest first)
                transactions.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                
                // Display only the 10 most recent
                transactions.slice(0, 10).forEach(transaction => {
                    const row = document.createElement('tr');
                    
                    // Format items list
                    const itemsList = transaction.items.map(item => {
                        return `${item.name} (${item.quantity}${item.unit ? ' ' + item.unit : ''})`;
                    }).join(', ');
                    
                    row.innerHTML = `
                        <td>${transaction.jobId}</td>
                        <td>${transaction.personName}</td>
                        <td>${transaction.purpose}</td>
                        <td>${formatDate(transaction.date)}</td>
                        <td>${itemsList}</td>
                        <td><span class="status status-pending">Pending</span></td>
                    `;
                    
                    issuedItemsTable.appendChild(row);
                });
            });
        }
        
        // Return Items Functionality
        function setupReturnItems() {
            const returnForm = document.getElementById('return-form');
            const jobIdInput = document.getElementById('job-id');
            const returnItemsContainer = document.getElementById('return-items-container');
            
            // Set default date to today
            document.getElementById('return-date').valueAsDate = new Date();
            
            // Load job details when Job ID is entered
            jobIdInput.addEventListener('change', async () => {
                const jobId = jobIdInput.value.trim();
                if (!jobId) return;
                
                returnItemsContainer.innerHTML = '<p>Loading job details...</p>';
                
                try {
                    const transactionsRef = ref(database, 'transactions');
                    const jobQuery = query(transactionsRef, orderByChild('jobId'), equalTo(jobId));
                    
                    onValue(jobQuery, (snapshot) => {
                        if (!snapshot.exists()) {
                            returnItemsContainer.innerHTML = '<p class="error">Job ID not found</p>';
                            return;
                        }
                        
                        let transaction;
                        snapshot.forEach(childSnapshot => {
                            transaction = childSnapshot.val();
                        });
                        
                        if (transaction.status === 'returned') {
                            returnItemsContainer.innerHTML = '<p class="error">This job has already been returned</p>';
                            return;
                        }
                        
                        // Display items for return
                        let itemsHTML = '<h3>Items to Return</h3>';
                        transaction.items.forEach((item, index) => {
                            itemsHTML += `
                                <div class="form-group" style="display: flex; align-items: center; gap: 10px;">
                                    <input type="text" value="${item.name}" readonly style="flex: 2;">
                                    <input type="number" value="${item.quantity}" readonly style="flex: 1;">
                                    <input type="text" value="${item.unit || ''}" readonly style="flex: 1;">
                                    <label style="flex: 1;">
                                        <input type="checkbox" name="returned-item" value="${index}" checked> Returned
                                    </label>
                                </div>
                            `;
                        });
                        
                        returnItemsContainer.innerHTML = itemsHTML;
                    }, { onlyOnce: true });
                } catch (error) {
                    console.error('Error loading job details:', error);
                    returnItemsContainer.innerHTML = '<p class="error">Failed to load job details</p>';
                }
            });
            
            // Submit return form
            returnForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const jobId = document.getElementById('job-id').value.trim();
                const returnDate = document.getElementById('return-date').value;
                
                if (!jobId) {
                    alert('Please enter a valid Job ID');
                    return;
                }
                
                try {
                    // Find the transaction
                    const transactionsRef = ref(database, 'transactions');
                    const jobQuery = query(transactionsRef, orderByChild('jobId'), equalTo(jobId));
                    
                    onValue(jobQuery, async (snapshot) => {
                        if (!snapshot.exists()) {
                            alert('Job ID not found');
                            return;
                        }
                        
                        let transactionKey, transaction;
                        snapshot.forEach(childSnapshot => {
                            transactionKey = childSnapshot.key;
                            transaction = childSnapshot.val();
                        });
                        
                        if (transaction.status === 'returned') {
                            alert('This job has already been returned');
                            return;
                        }
                        
                        // Get which items are being returned
                        const returnedItems = [];
                        const checkboxes = document.querySelectorAll('input[name="returned-item"]:checked');
                        
                        checkboxes.forEach(checkbox => {
                            const index = parseInt(checkbox.value);
                            returnedItems.push(transaction.items[index]);
                        });
                        
                        if (returnedItems.length === 0) {
                            alert('Please select at least one item to return');
                            return;
                        }
                        
                        // Update transaction status
                        await set(ref(database, `transactions/${transactionKey}/status`), 'returned');
                        await set(ref(database, `transactions/${transactionKey}/returnDate`), returnDate);
                        await set(ref(database, `transactions/${transactionKey}/returnedItems`), returnedItems);
                        
                        // Update inventory
                        await updateInventory(returnedItems, 'return');
                        
                        alert('Items returned successfully!');
                        returnForm.reset();
                        returnItemsContainer.innerHTML = '';
                        
                        // Reload returned items table
                        loadReturnedItems();
                        loadDashboardData();
                    }, { onlyOnce: true });
                } catch (error) {
                    console.error('Error returning items:', error);
                    alert('Failed to return items. Please try again.');
                }
            });
            
            // Load returned items table
            loadReturnedItems();
        }
        
        // Load returned items table
        function loadReturnedItems() {
            const returnedItemsTable = document.getElementById('returned-items-table').querySelector('tbody');
            returnedItemsTable.innerHTML = '<tr><td colspan="5">Loading...</td></tr>';
            
            const transactionsRef = ref(database, 'transactions');
            const returnedQuery = query(transactionsRef, orderByChild('status'), equalTo('returned'));
            
            onValue(returnedQuery, (snapshot) => {
                returnedItemsTable.innerHTML = '';
                
                if (!snapshot.exists()) {
                    returnedItemsTable.innerHTML = '<tr><td colspan="5">No returned items found</td></tr>';
                    return;
                }
                
                const transactions = [];
                snapshot.forEach(childSnapshot => {
                    transactions.push(childSnapshot.val());
                });
                
                // Sort by date (newest first)
                transactions.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                
                // Display only the 10 most recent
                transactions.slice(0, 10).forEach(transaction => {
                    const row = document.createElement('tr');
                    
                    // Format returned items list
                    const itemsList = transaction.returnedItems.map(item => {
                        return `${item.name} (${item.quantity}${item.unit ? ' ' + item.unit : ''})`;
                    }).join(', ');
                    
                    row.innerHTML = `
                        <td>${transaction.jobId}</td>
                        <td>${transaction.personName}</td>
                        <td>${formatDate(transaction.returnDate)}</td>
                        <td>${itemsList}</td>
                        <td><span class="status status-completed">Completed</span></td>
                    `;
                    
                    returnedItemsTable.appendChild(row);
                });
            });
        }
        
        // Reports Functionality
        function setupReports() {
            const reportType = document.getElementById('report-type');
            const reportDate = document.getElementById('report-date');
            const reportMonth = document.getElementById('report-month');
            const reportYear = document.getElementById('report-year');
            const generateBtn = document.getElementById('generate-report');
            const printBtn = document.getElementById('print-report');
            
            // Set default date to today
            reportDate.valueAsDate = new Date();
            reportYear.value = new Date().getFullYear();
            reportMonth.value = (new Date().getMonth() + 1).toString().padStart(2, '0');
            
            // Show/hide filters based on report type
            reportType.addEventListener('change', () => {
                reportDate.style.display = 'none';
                reportMonth.style.display = 'none';
                reportYear.style.display = 'none';
                
                switch (reportType.value) {
                    case 'daily':
                        reportDate.style.display = 'block';
                        break;
                    case 'weekly':
                        // For weekly, we'll use the date input to select the start of the week
                        reportDate.style.display = 'block';
                        break;
                    case 'monthly':
                        reportMonth.style.display = 'block';
                        reportYear.style.display = 'block';
                        break;
                    case 'annual':
                        reportYear.style.display = 'block';
                        break;
                }
            });
            
            // Generate report
            generateBtn.addEventListener('click', () => {
                const type = reportType.value;
                let title = '';
                let startDate, endDate;
                
                switch (type) {
                    case 'daily':
                        startDate = new Date(reportDate.value);
                        endDate = new Date(reportDate.value);
                        endDate.setDate(endDate.getDate() + 1);
                        title = `Daily Report for ${formatDate(reportDate.value)}`;
                        break;
                    case 'weekly':
                        const date = new Date(reportDate.value);
                        // Get start of week (Sunday)
                        const day = date.getDay();
                        const diff = date.getDate() - day;
                        startDate = new Date(date.setDate(diff));
                        endDate = new Date(startDate);
                        endDate.setDate(endDate.getDate() + 7);
                        title = `Weekly Report for Week of ${formatDate(startDate.toISOString().split('T')[0])}`;
                        break;
                    case 'monthly':
                        const month = reportMonth.value;
                        const year = reportYear.value;
                        startDate = new Date(`${year}-${month}-01`);
                        endDate = new Date(startDate);
                        endDate.setMonth(endDate.getMonth() + 1);
                        title = `Monthly Report for ${getMonthName(month)} ${year}`;
                        break;
                    case 'annual':
                        const selectedYear = reportYear.value;
                        startDate = new Date(`${selectedYear}-01-01`);
                        endDate = new Date(`${selectedYear}-12-31`);
                        title = `Annual Report for ${selectedYear}`;
                        break;
                    case 'inventory':
                        title = 'Current Inventory Report';
                        generateInventoryReport();
                        return;
                }
                
                if (type !== 'inventory') {
                    generateTransactionReport(startDate, endDate, title);
                }
            });
            
            // Print report
            printBtn.addEventListener('click', () => {
                window.print();
            });
        }
        
        // Generate transaction report
        function generateTransactionReport(startDate, endDate, title) {
            const reportContent = document.getElementById('report-content');
            reportContent.innerHTML = '<p>Generating report...</p>';
            document.getElementById('report-title').textContent = title;
            
            const transactionsRef = ref(database, 'transactions');
            onValue(transactionsRef, (snapshot) => {
                if (!snapshot.exists()) {
                    reportContent.innerHTML = '<p>No data found for the selected period</p>';
                    return;
                }
                
                const transactions = [];
                snapshot.forEach(childSnapshot => {
                    const transaction = childSnapshot.val();
                    const transactionDate = new Date(transaction.timestamp);
                    
                    if (transactionDate >= startDate && transactionDate < endDate) {
                        transactions.push(transaction);
                    }
                });
                
                if (transactions.length === 0) {
                    reportContent.innerHTML = '<p>No data found for the selected period</p>';
                    return;
                }
                
                // Sort by date
                transactions.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
                
                // Generate report HTML
                let reportHTML = `
                    <div class="report-summary">
                        <p><strong>Period:</strong> ${title.replace('Report for ', '')}</p>
                        <p><strong>Total Transactions:</strong> ${transactions.length}</p>
                    </div>
                    <table class="report-table">
                        <thead>
                            <tr>
                                <th>Job ID</th>
                                <th>Date</th>
                                <th>Person</th>
                                <th>Purpose</th>
                                <th>Items</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                let issuedItems = 0;
                let returnedItems = 0;
                const itemQuantities = {};
                
                transactions.forEach(transaction => {
                    // Count items for summary
                    if (transaction.status === 'issued') {
                        issuedItems += transaction.items.length;
                        transaction.items.forEach(item => {
                            if (!itemQuantities[item.name]) {
                                itemQuantities[item.name] = { issued: 0, returned: 0, unit: item.unit };
                            }
                            itemQuantities[item.name].issued += item.quantity;
                        });
                    } else if (transaction.status === 'returned') {
                        returnedItems += transaction.returnedItems.length;
                        transaction.returnedItems.forEach(item => {
                            if (!itemQuantities[item.name]) {
                                itemQuantities[item.name] = { issued: 0, returned: 0, unit: item.unit };
                            }
                            itemQuantities[item.name].returned += item.quantity;
                        });
                    }
                    
                    // Format items list
                    const items = transaction.status === 'issued' ? transaction.items : transaction.returnedItems;
                    const itemsList = items.map(item => {
                        return `${item.name} (${item.quantity}${item.unit ? ' ' + item.unit : ''})`;
                    }).join(', ');
                    
                    reportHTML += `
                        <tr>
                            <td>${transaction.jobId}</td>
                            <td>${formatDate(transaction.date)}</td>
                            <td>${transaction.personName}</td>
                            <td>${transaction.purpose}</td>
                            <td>${itemsList}</td>
                            <td><span class="status ${transaction.status === 'issued' ? 'status-pending' : 'status-completed'}">${transaction.status === 'issued' ? 'Pending' : 'Completed'}</span></td>
                        </tr>
                    `;
                });
                
                reportHTML += `
                        </tbody>
                    </table>
                    
                    <div class="report-summary" style="margin-top: 30px;">
                        <h3>Summary by Item</h3>
                        <table class="summary-table">
                            <thead>
                                <tr>
                                    <th>Item Name</th>
                                    <th>Issued Quantity</th>
                                    <th>Returned Quantity</th>
                                    <th>Balance</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                // Add item summary
                Object.keys(itemQuantities).forEach(itemName => {
                    const item = itemQuantities[itemName];
                    const balance = item.issued - item.returned;
                    
                    reportHTML += `
                        <tr>
                            <td>${itemName}</td>
                            <td>${item.issued} ${item.unit || ''}</td>
                            <td>${item.returned} ${item.unit || ''}</td>
                            <td>${balance} ${item.unit || ''}</td>
                        </tr>
                    `;
                });
                
                reportHTML += `
                            </tbody>
                        </table>
                    </div>
                `;
                
                reportContent.innerHTML = reportHTML;
            });
        }
        
        // Generate inventory report
        function generateInventoryReport() {
            const reportContent = document.getElementById('report-content');
            reportContent.innerHTML = '<p>Generating inventory report...</p>';
            document.getElementById('report-title').textContent = 'Current Inventory Report';
            
            const inventoryRef = ref(database, 'inventory');
            onValue(inventoryRef, (snapshot) => {
                if (!snapshot.exists()) {
                    reportContent.innerHTML = '<p>No inventory data found</p>';
                    return;
                }
                
                const inventory = [];
                snapshot.forEach(childSnapshot => {
                    inventory.push(childSnapshot.val());
                });
                
                // Sort by item name
                inventory.sort((a, b) => a.name.localeCompare(b.name));
                
                let reportHTML = `
                    <div class="report-summary">
                        <p><strong>Total Items in Inventory:</strong> ${inventory.length}</p>
                    </div>
                    <table class="report-table">
                        <thead>
                            <tr>
                                <th>Item Name</th>
                                <th>Category</th>
                                <th>Quantity</th>
                                <th>Unit</th>
                                <th>Description</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                inventory.forEach(item => {
                    reportHTML += `
                        <tr>
                            <td>${item.name}</td>
                            <td>${item.category || '-'}</td>
                            <td>${item.quantity}</td>
                            <td>${item.unit || '-'}</td>
                            <td>${item.description || '-'}</td>
                        </tr>
                    `;
                });
                
                reportHTML += `
                        </tbody>
                    </table>
                `;
                
                reportContent.innerHTML = reportHTML;
            });
        }
        
        // Add Items Functionality
        function setupAddItems() {
            const addItemForm = document.getElementById('add-item-form');
            
            // Submit add item form
            addItemForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const name = document.getElementById('item-name').value;
                const category = document.getElementById('item-category').value;
                const quantity = parseInt(document.getElementById('item-quantity').value);
                const unit = document.getElementById('item-unit').value;
                const description = document.getElementById('item-description').value;
                
                // Check if item already exists
                const inventoryRef = ref(database, 'inventory');
                const itemQuery = query(inventoryRef, orderByChild('name'), equalTo(name));
                
                onValue(itemQuery, async (snapshot) => {
                    if (snapshot.exists()) {
                        // Item exists, update quantity
                        let itemKey, existingItem;
                        snapshot.forEach(childSnapshot => {
                            itemKey = childSnapshot.key;
                            existingItem = childSnapshot.val();
                        });
                        
                        const newQuantity = existingItem.quantity + quantity;
                        await set(ref(database, `inventory/${itemKey}/quantity`), newQuantity);
                        
                        alert(`Item quantity updated successfully! New quantity: ${newQuantity}`);
                    } else {
                        // Item doesn't exist, create new
                        const newItemRef = push(inventoryRef);
                        await set(newItemRef, {
                            name,
                            category: category || null,
                            quantity,
                            unit: unit || null,
                            description: description || null,
                            timestamp: new Date().toISOString()
                        });
                        
                        alert('New item added to inventory successfully!');
                    }
                    
                    addItemForm.reset();
                    loadInventory();
                    loadDashboardData();
                }, { onlyOnce: true });
            });
            
            // Load inventory table
            loadInventory();
        }
        
        // Load inventory table
        function loadInventory() {
            const inventoryTable = document.getElementById('inventory-table').querySelector('tbody');
            inventoryTable.innerHTML = '<tr><td colspan="5">Loading...</td></tr>';
            
            const inventoryRef = ref(database, 'inventory');
            
            onValue(inventoryRef, (snapshot) => {
                inventoryTable.innerHTML = '';
                
                if (!snapshot.exists()) {
                    inventoryTable.innerHTML = '<tr><td colspan="5">No inventory items found</td></tr>';
                    return;
                }
                
                const inventory = [];
                snapshot.forEach(childSnapshot => {
                    inventory.push(childSnapshot.val());
                });
                
                // Sort by name
                inventory.sort((a, b) => a.name.localeCompare(b.name));
                
                inventory.forEach(item => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${item.name}</td>
                        <td>${item.category || '-'}</td>
                        <td>${item.quantity}</td>
                        <td>${item.unit || '-'}</td>
                        <td>${item.description || '-'}</td>
                    `;
                    inventoryTable.appendChild(row);
                });
            });
        }
        
        // Dashboard Functionality
        function loadDashboardData() {
            // Load total items count
            const inventoryRef = ref(database, 'inventory');
            onValue(inventoryRef, (snapshot) => {
                document.getElementById('total-items').textContent = snapshot.exists() ? snapshot.size : '0';
            });
            
            // Load active jobs count
            const transactionsRef = ref(database, 'transactions');
            const activeJobsQuery = query(transactionsRef, orderByChild('status'), equalTo('issued'));
            onValue(activeJobsQuery, (snapshot) => {
                document.getElementById('active-jobs').textContent = snapshot.exists() ? snapshot.size : '0';
            });
            
            // Load items checked out count
            const returnedQuery = query(transactionsRef, orderByChild('status'), equalTo('returned'));
            onValue(returnedQuery, (snapshot) => {
                document.getElementById('items-checked-out').textContent = snapshot.exists() ? snapshot.size : '0';
            });
            
            // Load recent activities
            const activitiesList = document.getElementById('activities-list');
            activitiesList.innerHTML = '<div class="activity-item"><p>Loading activities...</p></div>';
            
            onValue(transactionsRef, (snapshot) => {
                activitiesList.innerHTML = '';
                
                if (!snapshot.exists()) {
                    activitiesList.innerHTML = '<div class="activity-item"><p>No recent activities</p></div>';
                    return;
                }
                
                const activities = [];
                snapshot.forEach(childSnapshot => {
                    activities.push(childSnapshot.val());
                });
                
                // Sort by timestamp (newest first)
                activities.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                
                // Display only the 5 most recent
                activities.slice(0, 5).forEach(activity => {
                    const activityItem = document.createElement('div');
                    activityItem.className = 'activity-item';
                    
                    const icon = document.createElement('div');
                    icon.className = 'activity-icon';
                    icon.innerHTML = activity.status === 'issued' ? '<i class="fas fa-arrow-up"></i>' : '<i class="fas fa-arrow-down"></i>';
                    
                    const details = document.createElement('div');
                    details.className = 'activity-details';
                    
                    const title = document.createElement('h4');
                    title.textContent = activity.status === 'issued' ? 'Items Issued' : 'Items Returned';
                    
                    const description = document.createElement('p');
                    const items = activity.status === 'issued' ? activity.items : activity.returnedItems;
                    description.textContent = `${activity.personName} - ${items.map(item => item.name).join(', ')}`;
                    
                    const time = document.createElement('span');
                    time.className = 'activity-time';
                    time.textContent = formatTimeAgo(activity.timestamp);
                    
                    details.appendChild(title);
                    details.appendChild(description);
                    details.appendChild(time);
                    
                    activityItem.appendChild(icon);
                    activityItem.appendChild(details);
                    
                    activitiesList.appendChild(activityItem);
                });
            });
        }
        
        // Helper function to update inventory
        async function updateInventory(items, action) {
            const inventoryRef = ref(database, 'inventory');
            
            for (const item of items) {
                // Check if item exists
                const itemQuery = query(inventoryRef, orderByChild('name'), equalTo(item.name));
                
                onValue(itemQuery, async (snapshot) => {
                    if (snapshot.exists()) {
                        // Item exists, update quantity
                        let itemKey, existingItem;
                        snapshot.forEach(childSnapshot => {
                            itemKey = childSnapshot.key;
                            existingItem = childSnapshot.val();
                        });
                        
                        let newQuantity;
                        if (action === 'issue') {
                            newQuantity = existingItem.quantity - item.quantity;
                        } else {
                            newQuantity = existingItem.quantity + item.quantity;
                        }
                        
                        await set(ref(database, `inventory/${itemKey}/quantity`), newQuantity);
                    } else if (action === 'return') {
                        // Item doesn't exist but is being returned - create new entry
                        const newItemRef = push(inventoryRef);
                        await set(newItemRef, {
                            name: item.name,
                            quantity: item.quantity,
                            unit: item.unit || null,
                            timestamp: new Date().toISOString()
                        });
                    }
                }, { onlyOnce: true });
            }
        }
        
        // Helper function to format date
        function formatDate(dateString) {
            const options = { year: 'numeric', month: 'short', day: 'numeric' };
            return new Date(dateString).toLocaleDateString(undefined, options);
        }
        
        // Helper function to format time ago
        function formatTimeAgo(timestamp) {
            const now = new Date();
            const date = new Date(timestamp);
            const seconds = Math.floor((now - date) / 1000);
            
            let interval = Math.floor(seconds / 31536000);
            if (interval >= 1) return `${interval} year${interval === 1 ? '' : 's'} ago`;
            
            interval = Math.floor(seconds / 2592000);
            if (interval >= 1) return `${interval} month${interval === 1 ? '' : 's'} ago`;
            
            interval = Math.floor(seconds / 86400);
            if (interval >= 1) return `${interval} day${interval === 1 ? '' : 's'} ago`;
            
            interval = Math.floor(seconds / 3600);
            if (interval >= 1) return `${interval} hour${interval === 1 ? '' : 's'} ago`;
            
            interval = Math.floor(seconds / 60);
            if (interval >= 1) return `${interval} minute${interval === 1 ? '' : 's'} ago`;
            
            return 'just now';
        }
        
        // Helper function to get month name
        function getMonthName(monthNumber) {
            const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
            return months[parseInt(monthNumber) - 1];
        }
    </script>
</body>
</html>